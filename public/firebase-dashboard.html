<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Onion Hydroponic System - Firebase Dashboard</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://code.highcharts.com/highcharts.js"></script>
        <script src="https://code.highcharts.com/modules/time.js"></script>
        <script src="https://moment.github.io/luxon/global/luxon.min.js"></script>
        <!-- Firebase SDK -->
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
        <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    </head>

    <body class="bg-gray-100">
        <!-- Header Section -->
        <header class="bg-white shadow-md">
            <div class="container mx-auto px-4 py-6">
                <h1 class="text-xl font-bold text-center text-gray-800 mb-4">
                    ðŸ§…Onion Hydroponic SystemðŸ§…
                </h1>
                <div class="text-center">
                    <h2 class="text-l font-semibold text-gray-700 mb-2">
                        Group Members:
                    </h2>
                    <div
                        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-0.3 max-w-3xl mx-auto"
                    >
                        <p class="text-gray-600">Deejay Piaoan</p>
                        <p class="text-gray-600">Atornee Maala</p>
                        <p class="text-gray-600">Oliver Narvaza</p>
                        <p class="text-gray-600">Marjolyn Leal</p>
                        <p class="text-gray-600">Shekeina Dabalos</p>
                        <p class="text-gray-600">John Enrique Dela Cruz</p>
                    </div>
                </div>
            </div>
        </header>

        <div class="container mx-auto px-4 py-8">
            <h1 class="text-3xl font-bold text-center mb-4">
                ESP32 Sensor Readings
            </h1>
            <p class="text-center text-gray-600 mb-8" id="reading-timestamp">
                Last Updated: <span id="timestamp"></span>
            </p>

            <div
                class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-4xl mx-auto mb-12"
            >
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Temperature</h2>
                    <div class="flex items-center justify-center">
                        <p
                            class="text-4xl font-bold text-blue-600"
                            id="temperature"
                        >
                            N/A
                        </p>
                        <span class="ml-2 text-2xl" id="temperature-arrow"
                            >-</span
                        >
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Humidity</h2>
                    <div class="flex items-center justify-center">
                        <p
                            class="text-4xl font-bold text-green-600"
                            id="humidity"
                        >
                            N/A
                        </p>
                        <span class="ml-2 text-2xl" id="humidity-arrow">-</span>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Soil Moisture</h2>
                    <div class="flex items-center justify-center">
                        <p
                            class="text-4xl font-bold text-purple-600"
                            id="soil_moisture"
                        >
                            N/A
                        </p>
                        <span class="ml-2 text-2xl" id="soil_moisture-arrow"
                            >-</span
                        >
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Motion</h2>
                    <div class="flex items-center justify-center">
                        <p
                            class="text-4xl font-bold text-orange-600"
                            id="motion_detected"
                        >
                            N/A
                        </p>
                        <span class="ml-2 text-2xl" id="motion_detected-arrow"
                            >-</span
                        >
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Relay State</h2>
                    <div class="flex items-center justify-center">
                        <p
                            class="text-4xl font-bold text-red-600"
                            id="relay_state"
                        >
                            N/A
                        </p>
                        <span class="ml-2 text-2xl" id="relay_state-arrow"
                            >-</span
                        >
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 gap-8 max-w-6xl mx-auto">
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">
                        Temperature History
                    </h2>
                    <div id="chart-temperature" class="w-full h-80"></div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">Humidity History</h2>
                    <div id="chart-humidity" class="w-full h-80"></div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-semibold mb-4">
                        Soil Moisture History
                    </h2>
                    <div id="chart-soil-moisture" class="w-full h-80"></div>
                </div>
            </div>
        </div>

        <script>
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyABHuNuRQSL3IVVBQ-7dlnaBmlQMBMO_2g",
                authDomain: "onion-hydroponic.firebaseapp.com",
                databaseURL:
                    "https://onion-hydroponic-default-rtdb.firebaseio.com",
                projectId: "onion-hydroponic",
                storageBucket: "onion-hydroponic.firebasestorage.app",
                messagingSenderId: "184454714684",
                appId: "1:184454714684:web:da88b18abb102d3a363a39",
                measurementId: "G-E7ER6QDRPC",
            };

            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const database = firebase.database();

            // Set Highcharts timezone to Philippines
            Highcharts.setOptions({
                time: {
                    timezone: "Asia/Manila",
                    useUTC: false,
                },
            });

            // Helper function to format date in Philippine time
            function formatPhTime(date) {
                return luxon.DateTime.fromJSDate(date)
                    .setZone("Asia/Manila")
                    .toFormat("LLLL d, yyyy h:mm:ss a");
            }

            // Initialize charts
            var chartT = new Highcharts.Chart({
                chart: { renderTo: "chart-temperature", type: "spline" },
                title: { text: "Temperature History" },
                xAxis: { type: "datetime" },
                yAxis: { title: { text: "Temperature (Â°C)" } },
                series: [{ name: "Temperature", data: [] }],
            });

            var chartH = new Highcharts.Chart({
                chart: { renderTo: "chart-humidity", type: "spline" },
                title: { text: "Humidity History" },
                xAxis: { type: "datetime" },
                yAxis: { title: { text: "Humidity (%)" } },
                series: [{ name: "Humidity", data: [] }],
            });

            var chartSM = new Highcharts.Chart({
                chart: { renderTo: "chart-soil-moisture", type: "spline" },
                title: { text: "Soil Moisture History" },
                xAxis: { type: "datetime" },
                yAxis: { title: { text: "Soil Moisture (%)" } },
                series: [{ name: "Soil Moisture", data: [] }],
            });

            // Store previous values
            let previousValues = {
                temperature: null,
                humidity: null,
                soil_moisture: null,
                motion_detected: null,
                relay_state: null,
            };

            function updateArrow(elementId, currentValue, previousValue) {
                const arrowElement = document.getElementById(elementId);
                if (previousValue === null) {
                    arrowElement.textContent = "-";
                    return;
                }
                if (currentValue > previousValue) {
                    arrowElement.textContent = "â†‘";
                    arrowElement.className = "ml-2 text-2xl text-green-500";
                } else if (currentValue < previousValue) {
                    arrowElement.textContent = "â†“";
                    arrowElement.className = "ml-2 text-2xl text-red-500";
                } else {
                    arrowElement.textContent = "-";
                    arrowElement.className = "ml-2 text-2xl text-gray-500";
                }
            }

            // Listen for real-time updates from Firebase
            database.ref("sensor_data").on("value", (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    const x = new Date().getTime();

                    // Update temperature
                    const currentTemp = parseFloat(data.temperature);
                    document.getElementById("temperature").textContent =
                        currentTemp.toFixed(1) + "Â°C";
                    updateArrow(
                        "temperature-arrow",
                        currentTemp,
                        previousValues.temperature
                    );
                    previousValues.temperature = currentTemp;
                    chartT.series[0].addPoint(
                        [x, currentTemp],
                        true,
                        chartT.series[0].data.length > 40
                    );

                    // Update humidity
                    const currentHumidity = parseFloat(data.humidity);
                    document.getElementById("humidity").textContent =
                        currentHumidity.toFixed(1) + "%";
                    updateArrow(
                        "humidity-arrow",
                        currentHumidity,
                        previousValues.humidity
                    );
                    previousValues.humidity = currentHumidity;
                    chartH.series[0].addPoint(
                        [x, currentHumidity],
                        true,
                        chartH.series[0].data.length > 40
                    );

                    // Update soil moisture
                    const currentSoilMoisture = parseFloat(data.soil_moisture);
                    document.getElementById("soil_moisture").textContent =
                        currentSoilMoisture.toFixed(1) + "%";
                    updateArrow(
                        "soil_moisture-arrow",
                        currentSoilMoisture,
                        previousValues.soil_moisture
                    );
                    previousValues.soil_moisture = currentSoilMoisture;
                    chartSM.series[0].addPoint(
                        [x, currentSoilMoisture],
                        true,
                        chartSM.series[0].data.length > 40
                    );

                    // Update motion and relay state
                    document.getElementById("motion_detected").textContent =
                        data.motion_detected ? "Detected" : "None";
                    document.getElementById("relay_state").textContent =
                        data.relay_state ? "ON" : "OFF";

                    // Update timestamp
                    document.getElementById("timestamp").textContent =
                        formatPhTime(new Date());
                }
            });
        </script>
    </body>
</html>
